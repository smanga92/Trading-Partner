<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0A0E27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Your Pre-Trade Accountability Partner">
    <title>Trading Partner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-primary: #0A0E27;
            --bg-secondary: #111628;
            --bg-tertiary: #1A1F3A;
            --accent-cyan: #00D9FF;
            --accent-purple: #7B61FF;
            --text-primary: #FFFFFF;
            --text-secondary: #B8C5D6;
            --border: #2D3548;
            --success: #00FF94;
            --danger: #FF4757;
            --warning: #FFB800;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(123,97,255,0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(0,217,255,0.08) 0%, transparent 50%);
            animation: bgpulse 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes bgpulse { 0%,100%{opacity:.5} 50%{opacity:1} }

        .app-container {
            max-width: 100%;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* ===== HEADER ===== */
        .app-header {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            padding: 14px 20px;
            border-bottom: 2px solid var(--accent-cyan);
            box-shadow: 0 4px 20px rgba(0,217,255,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 800px;
            margin: 0 auto;
        }

        .app-title {
            font-family: 'Playfair Display', serif;
            font-size: 24px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions { display: flex; align-items: center; gap: 8px; }

        .back-btn {
            display: none;
            align-items: center;
            gap: 6px;
            padding: 7px 14px;
            background: var(--bg-tertiary);
            border: 2px solid var(--accent-cyan);
            border-radius: 10px;
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .back-btn.show { display: flex; }
        .back-btn:hover { background: var(--accent-cyan); color: var(--bg-primary); transform: translateX(-3px); }

        .status-indicator {
            width: 10px; height: 10px;
            background: var(--success);
            border-radius: 50%;
            box-shadow: 0 0 10px var(--success);
            animation: blink 2s infinite;
        }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

        /* ===== ICON BUTTONS ===== */
        .icon-btn {
            width: 36px; height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        .icon-btn:hover { transform: scale(1.1); }
        .icon-btn.edit:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }
        .icon-btn.delete:hover { border-color: var(--danger); color: var(--danger); }

        /* ===== CHAT ===== */
        .chat-container {
            flex: 1;
            padding: 20px 10px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
            scroll-behavior: smooth;
        }

        .scroll-anchor { height: 1px; width: 1px; visibility: hidden; }

        .message { display: flex; width: 100%; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from{opacity:0;transform:translateY(20px)} to{opacity:1;transform:translateY(0)} }
        .message-bot { justify-content: flex-start; }
        .message-user { justify-content: flex-end; }

        .message-content { max-width: 85%; display: flex; flex-direction: column; gap: 4px; }
        .message-bubble {
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .message-bot .message-bubble {
            background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
            border: 1px solid var(--border);
            border-bottom-left-radius: 2px;
        }
        .message-user .message-bubble {
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-purple) 100%);
            color: var(--text-primary);
            border-bottom-right-radius: 2px;
        }
        .message-label {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            font-weight: 700;
            padding: 0 4px;
            margin-bottom: 2px;
        }

        /* ===== BUTTONS ===== */
        .button-group { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; width: 100%; }

        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 0 1 auto;
            white-space: nowrap;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            color: var(--text-primary);
            box-shadow: 0 4px 15px rgba(0,217,255,0.3);
            flex: 1 1 auto;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,217,255,0.4); }
        .btn-verdict {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }
        .btn-verdict:hover { border-color: var(--accent-cyan); background: var(--bg-secondary); transform: scale(1.05); }
        .btn-verdict.buy { border-color: var(--success); color: var(--success); }
        .btn-verdict.sell { border-color: var(--danger); color: var(--danger); }
        .btn-verdict.standby { border-color: var(--warning); color: var(--warning); }

        /* ===== INPUT ===== */
        .input-container {
            padding: 14px 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            position: sticky;
            bottom: 0;
            max-width: 800px;
            width: 100%;
            margin: 0 auto;
        }
        .input-wrapper { display: flex; gap: 12px; align-items: center; }
        .input-field {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 14px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }
        .input-field:focus { border-color: var(--accent-cyan); box-shadow: 0 0 0 3px rgba(0,217,255,0.1); }
        .input-field::placeholder { color: var(--text-secondary); }
        textarea.input-field { resize: vertical; min-height: 46px; max-height: 150px; }
        .send-btn {
            width: 46px; height: 46px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,217,255,0.3);
            flex-shrink: 0;
        }
        .send-btn:hover { transform: scale(1.1) rotate(15deg); }

        /* ===== LOADING ===== */
        .loading { display: flex; gap: 6px; padding: 12px; }
        .loading-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--accent-cyan);
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-dot:nth-child(1){animation-delay:-.32s}
        .loading-dot:nth-child(2){animation-delay:-.16s}
        @keyframes bounce { 0%,80%,100%{transform:scale(0)} 40%{transform:scale(1)} }

        /* ===== WELCOME ===== */
        .welcome-screen { text-align: center; padding: 60px 20px; animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from{opacity:0} to{opacity:1} }
        .welcome-icon { font-size: 72px; margin-bottom: 20px; animation: float 3s ease-in-out infinite; display: block; }
        @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-16px)} }
        .welcome-title {
            font-family: 'Playfair Display', serif;
            font-size: 32px; font-weight: 900;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .welcome-subtitle { font-size: 14px; color: var(--text-secondary); margin-bottom: 32px; line-height: 1.6; }

        /* ===== SNAPSHOT ===== */
        .snapshot-container {
            margin-top: 12px; padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            border: 2px solid var(--accent-cyan);
            box-shadow: 0 8px 30px rgba(0,217,255,0.2);
        }
        .snapshot-image {
            width: 100%; border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .snapshot-image:hover { transform: scale(1.01); }
        .snapshot-actions { margin-top: 12px; display: flex; gap: 10px; flex-wrap: wrap; }

        /* ===== HISTORY PANEL ===== */
        .history-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin: 6px 0;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .history-card:hover { border-color: var(--accent-cyan); transform: translateX(4px); }
        .history-card-header { display: flex; justify-content: space-between; align-items: center; }
        .history-card-time { font-size: 13px; color: var(--accent-cyan); font-weight: 700; }
        .history-card-pairs { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .history-card-badge {
            font-size: 11px; padding: 3px 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
        }

        /* ===== SCROLL TO BOTTOM ===== */
        .scroll-to-bottom {
            position: fixed;
            bottom: 100px; right: 30px;
            width: 44px; height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(0,217,255,0.4);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .scroll-to-bottom.show { display: flex; }
        .scroll-to-bottom:hover { transform: scale(1.1); }

        /* ===== SETTINGS OVERLAY ===== */
        .settings-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10,14,39,0.95);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .settings-overlay.show { display: flex; }

        .settings-panel {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            border: 2px solid var(--accent-cyan);
            border-radius: 20px;
            width: 92%;
            max-width: 720px;
            max-height: 88vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,217,255,0.3);
        }

        .settings-header {
            position: sticky; top: 0;
            background: var(--bg-primary);
            padding: 18px 20px;
            border-bottom: 2px solid var(--accent-cyan);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 10;
        }
        .settings-title {
            font-family: 'Playfair Display', serif;
            font-size: 22px; font-weight: 900;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .close-settings-btn {
            width: 34px; height: 34px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .close-settings-btn:hover { border-color: var(--danger); color: var(--danger); transform: rotate(90deg); }

        .settings-content { padding: 20px; }
        .settings-section { margin-bottom: 28px; }
        .settings-section-title {
            font-size: 16px; font-weight: 700;
            color: var(--accent-cyan);
            margin-bottom: 14px;
            display: flex; align-items: center; gap: 8px;
        }

        /* ===== SETTINGS TABS ===== */
        .settings-tabs {
            display: flex; gap: 0;
            border-bottom: 2px solid var(--border);
            margin-bottom: 20px;
        }
        .settings-tab {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .settings-tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }
        .settings-tab:hover { color: var(--accent-cyan); }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* ===== CONFIG ITEMS ===== */
        .config-list {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .config-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s ease;
        }
        .config-item:hover { border-color: var(--accent-cyan); }
        .config-item:last-child { margin-bottom: 0; }
        .config-item-content { flex: 1; }
        .config-item-text { font-size: 14px; color: var(--text-primary); font-weight: 700; }
        .config-item-meta { font-size: 11px; color: var(--text-secondary); margin-top: 3px; }
        .config-item-actions { display: flex; gap: 6px; align-items: center; }

        .add-btn {
            width: 100%;
            padding: 11px;
            border: 2px dashed var(--border);
            border-radius: 10px;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px; font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .add-btn:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); background: var(--bg-tertiary); }

        /* ===== CUSTOM ANSWER GROUP ===== */
        .answer-group-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }
        .answer-group-card:hover { border-color: var(--accent-cyan); }
        .answer-group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .answer-group-name { font-size: 14px; font-weight: 700; color: var(--accent-cyan); }
        .answer-tags { display: flex; flex-wrap: wrap; gap: 6px; }
        .answer-tag {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 6px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .answer-tag.buy { border-color: var(--success); color: var(--success); }
        .answer-tag.sell { border-color: var(--danger); color: var(--danger); }
        .answer-tag.standby { border-color: var(--warning); color: var(--warning); }

        /* ===== IMPORT/EXPORT ===== */
        .import-export-btns { display: flex; gap: 12px; margin-top: 12px; }
        .settings-btn {
            flex: 1;
            padding: 13px;
            border-radius: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px; font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .settings-btn.import { background: var(--bg-tertiary); border: 2px solid var(--accent-purple); color: var(--accent-purple); }
        .settings-btn.import:hover { background: var(--accent-purple); color: var(--text-primary); transform: translateY(-2px); }
        .settings-btn.export { background: var(--bg-tertiary); border: 2px solid var(--accent-cyan); color: var(--accent-cyan); }
        .settings-btn.export:hover { background: var(--accent-cyan); color: var(--bg-primary); transform: translateY(-2px); }
        .settings-btn.danger { background: var(--bg-tertiary); border: 2px solid var(--danger); color: var(--danger); }
        .settings-btn.danger:hover { background: var(--danger); color: var(--text-primary); transform: translateY(-2px); }

        .save-settings-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple));
            border: none;
            border-radius: 12px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 15px; font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,217,255,0.3);
        }
        .save-settings-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 30px rgba(0,217,255,0.5); }

        /* ===== EDIT MODAL ===== */
        .edit-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .edit-modal.show { display: flex; }

        .edit-form {
            background: var(--bg-secondary);
            border: 2px solid var(--accent-cyan);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 520px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .edit-form-title { font-size: 18px; font-weight: 700; color: var(--accent-cyan); margin-bottom: 18px; }
        .form-group { margin-bottom: 18px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; color: var(--text-secondary); margin-bottom: 7px; }
        .form-input, .form-select {
            width: 100%;
            padding: 11px 14px;
            border: 2px solid var(--border);
            border-radius: 10px;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            outline: none;
            transition: all 0.3s ease;
        }
        .form-input:focus, .form-select:focus { border-color: var(--accent-cyan); box-shadow: 0 0 0 3px rgba(0,217,255,0.1); }
        .form-hint { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
        .form-actions { display: flex; gap: 10px; margin-top: 20px; }
        .form-btn {
            flex: 1; padding: 11px;
            border-radius: 10px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px; font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .form-btn.cancel { background: var(--bg-tertiary); border: 2px solid var(--border); color: var(--text-secondary); }
        .form-btn.cancel:hover { border-color: var(--danger); color: var(--danger); }
        .form-btn.save { background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); border: none; color: var(--text-primary); }
        .form-btn.save:hover { transform: translateY(-2px); }

        /* Answer builder in edit form */
        .answer-builder { display: flex; flex-direction: column; gap: 8px; }
        .answer-builder-row {
            display: flex;
            gap: 8px;
            align-items: center;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
        }
        .answer-builder-row input {
            flex: 1;
            padding: 7px 10px;
            border: 1px solid var(--border);
            border-radius: 7px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            outline: none;
        }
        .answer-builder-row input:focus { border-color: var(--accent-cyan); }
        .answer-color-select {
            padding: 6px 8px;
            border: 1px solid var(--border);
            border-radius: 7px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            outline: none;
            cursor: pointer;
        }
        .answer-remove-btn {
            width: 26px; height: 26px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--danger);
            font-size: 14px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
        }
        .answer-remove-btn:hover { border-color: var(--danger); background: rgba(255,71,87,0.1); }
        .add-answer-row-btn {
            padding: 8px;
            border: 1px dashed var(--border);
            border-radius: 8px;
            background: transparent;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px; font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .add-answer-row-btn:hover { border-color: var(--accent-cyan); color: var(--accent-cyan); }

        /* ===== SESSION HISTORY PANEL ===== */
        .history-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10,14,39,0.96);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .history-overlay.show { display: flex; }

        .history-panel {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            border: 2px solid var(--accent-purple);
            border-radius: 20px;
            width: 92%;
            max-width: 720px;
            max-height: 88vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(123,97,255,0.3);
        }
        .history-header {
            position: sticky; top: 0;
            background: var(--bg-primary);
            padding: 18px 20px;
            border-bottom: 2px solid var(--accent-purple);
            display: flex; align-items: center; justify-content: space-between;
            z-index: 10;
        }
        .history-title {
            font-family: 'Playfair Display', serif;
            font-size: 22px; font-weight: 900;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-cyan));
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }
        .close-history-btn {
            width: 34px; height: 34px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            color: var(--text-primary);
            font-size: 18px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.3s ease;
        }
        .close-history-btn:hover { border-color: var(--danger); color: var(--danger); transform: rotate(90deg); }

        .history-content { padding: 20px; }
        .history-empty { text-align: center; padding: 40px; color: var(--text-secondary); font-size: 14px; }

        .history-session-detail {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 14px;
        }
        .history-session-meta {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .history-session-time { font-size: 13px; color: var(--accent-cyan); font-weight: 700; }
        .history-session-actions { display: flex; gap: 8px; }
        .session-view-btn {
            padding: 6px 14px;
            border-radius: 8px;
            border: 1px solid var(--accent-purple);
            background: transparent;
            color: var(--accent-purple);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px; font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .session-view-btn:hover { background: var(--accent-purple); color: var(--text-primary); }
        .session-delete-btn {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .session-delete-btn:hover { border-color: var(--danger); color: var(--danger); }

        .history-answers-grid {
            display: grid;
            grid-template-columns: auto repeat(var(--num-cols), 1fr);
            gap: 0;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
            font-size: 12px;
        }
        .grid-header {
            background: var(--bg-tertiary);
            padding: 8px 10px;
            font-weight: 700;
            color: var(--accent-cyan);
            font-size: 11px;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border);
        }
        .grid-cell {
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-secondary);
            font-size: 12px;
            color: var(--text-secondary);
            word-break: break-word;
        }
        .grid-cell.pair-cell {
            font-weight: 700;
            color: var(--text-primary);
            background: rgba(0,217,255,0.04);
        }
        .grid-cell.buy-cell { color: var(--success); }
        .grid-cell.sell-cell { color: var(--danger); }
        .grid-cell.standby-cell { color: var(--warning); }

        #importFileInput { display: none; }

        @media (max-width: 480px) {
            .app-title { font-size: 20px; }
            .message-bubble { font-size: 13px; }
            .btn { padding: 9px 12px; font-size: 12px; }
            .scroll-to-bottom { right: 16px; bottom: 86px; }
        }

        .chat-container::-webkit-scrollbar { width: 5px; }
        .chat-container::-webkit-scrollbar-track { background: transparent; }
        .chat-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .chat-container::-webkit-scrollbar-thumb:hover { background: var(--accent-cyan); }
        .settings-panel::-webkit-scrollbar { width: 5px; }
        .settings-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .history-panel::-webkit-scrollbar { width: 5px; }
        .history-panel::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    </style>
</head>
<body>
<div class="app-container">
    <!-- Header -->
    <div class="app-header">
        <div class="header-content">
            <button class="back-btn" id="backBtn">‚Üê Back</button>
            <div class="app-title">Trading Partner</div>
            <div class="header-actions">
                <button class="icon-btn" id="historyBtn" style="font-size:18px;" title="Session History">üìã</button>
                <button class="icon-btn" id="settingsBtn" style="font-size:18px;" title="Settings">‚öôÔ∏è</button>
                <div class="status-indicator"></div>
            </div>
        </div>
    </div>

    <!-- Chat -->
    <div class="chat-container" id="chatContainer">
        <div class="scroll-anchor" id="scrollAnchor"></div>
    </div>

    <button class="scroll-to-bottom" id="scrollToBottomBtn">‚¨á</button>

    <div class="input-container" id="inputContainer" style="display:none;">
        <div class="input-wrapper">
            <textarea class="input-field" id="messageInput" placeholder="Type your answer..." rows="1"></textarea>
            <button class="send-btn" id="sendBtn">‚û§</button>
        </div>
    </div>
</div>

<!-- ===== SETTINGS MODAL ===== -->
<div class="settings-overlay" id="settingsOverlay">
    <div class="settings-panel">
        <div class="settings-header">
            <div class="settings-title">‚öôÔ∏è Configuration</div>
            <button class="close-settings-btn" id="closeSettingsBtn">‚úï</button>
        </div>
        <div class="settings-content">
            <div class="settings-tabs">
                <button class="settings-tab active" data-tab="pairs">üìä Pairs</button>
                <button class="settings-tab" data-tab="questions">üìù Questions</button>
                <button class="settings-tab" data-tab="answers">üéØ Answer Groups</button>
                <button class="settings-tab" data-tab="data">üíæ Data</button>
            </div>

            <!-- PAIRS TAB -->
            <div class="tab-content active" id="tab-pairs">
                <div class="settings-section">
                    <div class="settings-section-title">üìä Trading Pairs</div>
                    <div class="config-list" id="pairsList"></div>
                    <button class="add-btn" id="addPairBtn">+ Add Pair</button>
                </div>
            </div>

            <!-- QUESTIONS TAB -->
            <div class="tab-content" id="tab-questions">
                <div class="settings-section">
                    <div class="settings-section-title">üìù Questions</div>
                    <div class="config-list" id="questionsList"></div>
                    <button class="add-btn" id="addQuestionBtn">+ Add Question</button>
                </div>
            </div>

            <!-- ANSWER GROUPS TAB -->
            <div class="tab-content" id="tab-answers">
                <div class="settings-section">
                    <div class="settings-section-title">üéØ Custom Answer Groups</div>
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">
                        Built-in groups are read-only. Create custom groups to use your own answer options. Each answer can be tagged as Buy (green), Sell (red), Standby (yellow), or Neutral.
                    </p>
                    <div id="builtinGroupsList"></div>
                    <div style="margin:16px 0;border-top:1px solid var(--border);padding-top:16px;">
                        <div class="settings-section-title">‚ú® My Custom Groups</div>
                        <div id="customGroupsList"></div>
                        <button class="add-btn" id="addCustomGroupBtn">+ Create Custom Answer Group</button>
                    </div>
                </div>
            </div>

            <!-- DATA TAB -->
            <div class="tab-content" id="tab-data">
                <div class="settings-section">
                    <div class="settings-section-title">üíæ Import / Export</div>
                    <div class="import-export-btns">
                        <button class="settings-btn import" id="importBtn">üì• Import Config</button>
                        <button class="settings-btn export" id="exportBtn">üì§ Export Config</button>
                    </div>
                    <input type="file" id="importFileInput" accept=".json">
                </div>
                <div class="settings-section">
                    <div class="settings-section-title">üóëÔ∏è Session Data</div>
                    <p style="font-size:12px;color:var(--text-secondary);margin-bottom:14px;line-height:1.6;">
                        Sessions are automatically saved. You can clear all history below.
                    </p>
                    <button class="settings-btn danger" id="clearSessionsBtn" style="width:100%;">üóëÔ∏è Clear All Session History</button>
                </div>
            </div>

            <button class="save-settings-btn" id="saveSettingsBtn">üíæ Save & Close</button>
        </div>
    </div>
</div>

<!-- ===== HISTORY MODAL ===== -->
<div class="history-overlay" id="historyOverlay">
    <div class="history-panel">
        <div class="history-header">
            <div class="history-title">üìã Session History</div>
            <button class="close-history-btn" id="closeHistoryBtn">‚úï</button>
        </div>
        <div class="history-content" id="historyContent"></div>
    </div>
</div>

<!-- ===== EDIT MODAL ===== -->
<div class="edit-modal" id="editModal">
    <div class="edit-form" id="editForm"></div>
</div>

<script>
// ============================================
// BUILT-IN ANSWER GROUPS (read-only)
// ============================================
const BUILTIN_GROUPS = {
    bias: {
        name: 'Market Bias',
        answers: [
            { text: 'üìà Bullish', class: 'buy' },
            { text: 'üìâ Bearish', class: 'sell' },
            { text: '‚ÜîÔ∏è Sideways', class: 'standby' }
        ]
    },
    momentum: {
        name: 'Momentum',
        answers: [
            { text: 'üî• Bullish Strong', class: 'buy' },
            { text: 'üìà Bullish', class: 'buy' },
            { text: 'üåÖ Bullish Building', class: 'buy' },
            { text: 'üå§Ô∏è Bullish Fading', class: 'standby' },
            { text: '‚ö° Bullish Shifting', class: 'standby' },
            { text: 'üîÑ Bullish Exhausted', class: 'standby' },
            { text: '‚ùÑÔ∏è Bearish Strong', class: 'sell' },
            { text: 'üìâ Bearish', class: 'sell' },
            { text: 'üåë Bearish Building', class: 'sell' },
            { text: 'üå•Ô∏è Bearish Fading', class: 'standby' },
            { text: '‚ö° Bearish Shifting', class: 'standby' },
            { text: 'üîÑ Bearish Exhausted', class: 'standby' }
        ]
    },
    flow: {
        name: 'Order Flow',
        answers: [
            { text: '‚¨ÜÔ∏è Up', class: 'buy' },
            { text: '‚¨áÔ∏è Down', class: 'sell' },
            { text: '‚û°Ô∏è Mixed', class: 'standby' },
            { text: 'üî• Strong Up', class: 'buy' },
            { text: '‚ùÑÔ∏è Weak Down', class: 'sell' }
        ]
    },
    structure: {
        name: 'Market Structure',
        answers: [
            { text: 'üìä HL/HH', class: 'buy' },
            { text: 'üìâ LH/LL', class: 'sell' },
            { text: 'üîÑ Choppy', class: 'standby' },
            { text: 'üí• Break', class: '' },
            { text: 'üéØ Retest', class: '' },
            { text: 'üìç Support', class: '' },
            { text: 'üöß Resistance', class: '' }
        ]
    },
    verdict: {
        name: 'Trading Decision',
        answers: [
            { text: '‚ñ≤ Buy', class: 'buy' },
            { text: '‚ñº Sell', class: 'sell' },
            { text: 'üîÑ Buy to Sell', class: 'standby' },
            { text: 'üîÑ Sell to Buy', class: 'standby' },
            { text: '‚è∏ Stand by for Buys', class: 'standby' },
            { text: '‚è∏ Stand by for Sells', class: 'standby' }
        ]
    },
    strength: {
        name: 'Trend Strength',
        answers: [
            { text: 'üí™ Very Strong', class: 'buy' },
            { text: 'üëç Strong', class: 'buy' },
            { text: 'ü§∑ Moderate', class: 'standby' },
            { text: 'üëé Weak', class: 'sell' },
            { text: 'üíÄ Very Weak', class: 'sell' }
        ]
    },
    timeframe: {
        name: 'Timeframe Alignment',
        answers: [
            { text: '‚úÖ Aligned', class: 'buy' },
            { text: '‚ö†Ô∏è Partial', class: 'standby' },
            { text: '‚ùå Conflict', class: 'sell' }
        ]
    },
    liquidity: {
        name: 'Liquidity',
        answers: [
            { text: 'üéØ Int. Taken ‚Üí Ext. Above', class: 'buy' },
            { text: 'üéØ Int. Taken ‚Üí Ext. Below', class: 'sell' },
            { text: 'üí• Ext. Taken ‚Üí Extending Up', class: 'buy' },
            { text: 'üí• Ext. Taken ‚Üí Extending Down', class: 'sell' },
            { text: 'üëÄ Targeting Int. Above', class: 'standby' },
            { text: 'üëÄ Targeting Int. Below', class: 'standby' },
            { text: 'üëÄ Targeting Ext. Above', class: 'buy' },
            { text: 'üëÄ Targeting Ext. Below', class: 'sell' },
            { text: '‚ÜîÔ∏è Int. & Ext. Mixed', class: 'standby' },
            { text: '‚è∏ No Clear Target', class: 'standby' }
        ]
    },
    volume: {
        name: 'Volume Profile',
        answers: [
            { text: 'üìà High Volume', class: 'buy' },
            { text: 'üìâ Low Volume', class: 'sell' },
            { text: 'üìä Average', class: 'standby' },
            { text: 'üî• Climax', class: '' }
        ]
    }
};

// ============================================
// STORAGE KEYS
// ============================================
const STORAGE_KEYS = {
    CONFIG: 'tradingPartner_config',
    SESSIONS: 'tradingPartner_sessions',
    CUSTOM_GROUPS: 'tradingPartner_customGroups',
    DRAFT: 'tradingPartner_draft'
};

// ============================================
// STATE
// ============================================
const state = {
    phase: 'welcome',
    pairs: [],
    questions: [],
    questionGroups: {},
    customGroups: {},     // user-created answer groups
    currentPairIndex: 0,
    currentQuestionIndex: 0,
    answers: {},
    timestamp: '',
    setupStep: 'pairs',
    questionCount: 0,
    currentQuestionSetup: 0,
    answerHistory: [],
    sessions: []          // all saved sessions
};

// Get ALL available groups (builtin + custom)
function getAllGroups() {
    const custom = loadCustomGroups();
    return { ...BUILTIN_GROUPS, ...custom };
}

// ============================================
// PERSISTENCE
// ============================================
function loadCustomGroups() {
    try {
        const saved = localStorage.getItem(STORAGE_KEYS.CUSTOM_GROUPS);
        return saved ? JSON.parse(saved) : {};
    } catch(e) { return {}; }
}

function saveCustomGroups(groups) {
    localStorage.setItem(STORAGE_KEYS.CUSTOM_GROUPS, JSON.stringify(groups));
}

function loadConfig() {
    try {
        const saved = localStorage.getItem(STORAGE_KEYS.CONFIG);
        if (saved) {
            const parsed = JSON.parse(saved);
            state.pairs = parsed.pairs || [];
            state.questions = parsed.questions || [];
            state.questionGroups = parsed.questionGroups || {};
            state.customGroups = loadCustomGroups();
            if (state.pairs.length && state.questions.length) {
                // Check if there's an unfinished session draft
                const draft = loadDraft();
                state.phase = draft ? 'draft-resume' : 'welcome-back';
            }
        }
    } catch(e) {}
}

function saveConfig() {
    localStorage.setItem(STORAGE_KEYS.CONFIG, JSON.stringify({
        pairs: state.pairs,
        questions: state.questions,
        questionGroups: state.questionGroups
    }));
}

function loadSessions() {
    try {
        const saved = localStorage.getItem(STORAGE_KEYS.SESSIONS);
        return saved ? JSON.parse(saved) : [];
    } catch(e) { return []; }
}

function saveSession(sessionData) {
    const sessions = loadSessions();
    sessions.unshift(sessionData); // newest first
    // Keep max 100 sessions
    if (sessions.length > 100) sessions.splice(100);
    localStorage.setItem(STORAGE_KEYS.SESSIONS, JSON.stringify(sessions));
}

function deleteSession(index) {
    const sessions = loadSessions();
    sessions.splice(index, 1);
    localStorage.setItem(STORAGE_KEYS.SESSIONS, JSON.stringify(sessions));
}

function clearAllSessions() {
    localStorage.removeItem(STORAGE_KEYS.SESSIONS);
}

// ============================================
// DRAFT (in-progress session) PERSISTENCE
// ============================================
function saveDraft() {
    if (state.phase !== 'session') return;
    const draft = {
        timestamp: state.timestamp,
        currentPairIndex: state.currentPairIndex,
        currentQuestionIndex: state.currentQuestionIndex,
        answers: JSON.parse(JSON.stringify(state.answers)),
        answerHistory: [...state.answerHistory]
    };
    localStorage.setItem(STORAGE_KEYS.DRAFT, JSON.stringify(draft));
}

function loadDraft() {
    try {
        const saved = localStorage.getItem(STORAGE_KEYS.DRAFT);
        return saved ? JSON.parse(saved) : null;
    } catch(e) { return null; }
}

function clearDraft() {
    localStorage.removeItem(STORAGE_KEYS.DRAFT);
}

// ============================================
// DOM REFS
// ============================================
const chatContainer = document.getElementById('chatContainer');
const inputContainer = document.getElementById('inputContainer');
const messageInput = document.getElementById('messageInput');
const sendBtn = document.getElementById('sendBtn');
const backBtn = document.getElementById('backBtn');
const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
const settingsOverlay = document.getElementById('settingsOverlay');
const historyOverlay = document.getElementById('historyOverlay');
const editModal = document.getElementById('editModal');
const editForm = document.getElementById('editForm');

// ============================================
// UI HELPERS
// ============================================
function addMessage(text, isBot = true, buttons = null) {
    const messageDiv = document.createElement('div');
    messageDiv.className = isBot ? 'message message-bot' : 'message message-user';

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';

    const label = document.createElement('div');
    label.className = 'message-label';
    label.textContent = isBot ? 'Trading Partner' : 'You';

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.innerHTML = text.replace(/\n/g, '<br>');

    contentDiv.appendChild(label);
    contentDiv.appendChild(bubble);

    if (buttons) {
        const btnGroup = document.createElement('div');
        btnGroup.className = 'button-group';
        buttons.forEach(btn => {
            const button = document.createElement('button');
            button.className = `btn ${btn.class || 'btn-primary'}`;
            button.textContent = btn.text;
            button.onclick = btn.action;
            btnGroup.appendChild(button);
        });
        contentDiv.appendChild(btnGroup);
    }

    messageDiv.appendChild(contentDiv);
    const anchor = document.getElementById('scrollAnchor');
    chatContainer.insertBefore(messageDiv, anchor);
    scrollToAnchor();
}

function showLoading() {
    const div = document.createElement('div');
    div.className = 'message message-bot';
    div.id = 'loading';
    div.innerHTML = `<div class="message-content"><div class="message-label">Trading Partner</div><div class="message-bubble"><div class="loading"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div></div></div>`;
    const anchor = document.getElementById('scrollAnchor');
    chatContainer.insertBefore(div, anchor);
    scrollToAnchor();
}

function hideLoading() {
    const l = document.getElementById('loading');
    if (l) l.remove();
}

function showInput(placeholder = 'Type your answer...') {
    inputContainer.style.display = 'block';
    messageInput.placeholder = placeholder;
    messageInput.focus();
}

function hideInput() {
    inputContainer.style.display = 'none';
    messageInput.value = '';
}

function clearChat() {
    chatContainer.innerHTML = '';
    const anchor = document.createElement('div');
    anchor.className = 'scroll-anchor';
    anchor.id = 'scrollAnchor';
    chatContainer.appendChild(anchor);
}

function isUserAtBottom() {
    return (chatContainer.scrollHeight - chatContainer.scrollTop - chatContainer.clientHeight) < 150;
}

function scrollToAnchor() {
    const anchor = document.getElementById('scrollAnchor');
    if (isUserAtBottom()) {
        anchor.scrollIntoView({ behavior: 'smooth', block: 'end' });
    } else {
        scrollToBottomBtn.classList.add('show');
    }
}

function forceScrollToAnchor() {
    const anchor = document.getElementById('scrollAnchor');
    anchor.scrollIntoView({ behavior: 'smooth', block: 'end' });
    scrollToBottomBtn.classList.remove('show');
}

scrollToBottomBtn.addEventListener('click', () => {
    document.getElementById('scrollAnchor').scrollIntoView({ behavior: 'smooth', block: 'end' });
    scrollToBottomBtn.classList.remove('show');
});

chatContainer.addEventListener('scroll', () => {
    if (isUserAtBottom()) scrollToBottomBtn.classList.remove('show');
});

// ============================================
// WELCOME / SETUP
// ============================================
function showWelcome() {
    clearChat();
    if (state.phase === 'draft-resume') {
        const draft = loadDraft();
        const completedPairs = Object.keys(draft.answers || {}).filter(p => (draft.answers[p]||[]).length === state.questions.length);
        const totalAnswered = Object.values(draft.answers || {}).reduce((sum, a) => sum + a.length, 0);
        const totalNeeded = state.pairs.length * state.questions.length;
        const pct = Math.round((totalAnswered / totalNeeded) * 100);
        addMessage(
            `‚ö†Ô∏è You have an unfinished session!\n\nStarted: ${draft.timestamp}\nProgress: ${pct}% complete (${totalAnswered}/${totalNeeded} answers)\nPairs done: ${completedPairs.join(', ') || 'none'}\n\nWould you like to continue where you left off?`,
            true,
            [
                { text: '‚ñ∂ Resume Session', class: 'btn-primary', action: resumeDraft },
                { text: 'üóë Discard & Start Fresh', class: 'btn-verdict', action: () => { clearDraft(); state.phase = 'welcome-back'; showWelcome(); } }
            ]
        );
    } else if (state.phase === 'welcome-back') {
        addMessage(
            `Welcome back! üíô\n\nPairs: ${state.pairs.join(', ')}\n\nReady to start your session?`,
            true,
            [
                { text: '‚ñ∂ Start Session', class: 'btn-primary', action: startSession },
                { text: '‚öôÔ∏è Reconfigure', class: 'btn-verdict', action: startSetup }
            ]
        );
    } else {
        chatContainer.innerHTML = `
            <div class="welcome-screen">
                <span class="welcome-icon">üíπ</span>
                <div class="welcome-title">Trading Partner</div>
                <div class="welcome-subtitle">Your pre-trade accountability system.<br>Enforce discipline. Prevent impulsive trades.<br>Trade your plan, not your emotions.</div>
            </div>
        `;
        const anchor = document.createElement('div');
        anchor.className = 'scroll-anchor';
        anchor.id = 'scrollAnchor';
        chatContainer.appendChild(anchor);
        forceScrollToAnchor();
        setTimeout(() => {
            addMessage(
                "Welcome! I'm your trading accountability partner. üéØ\n\nLet's set up your custom trading framework.",
                true,
                [{ text: 'üöÄ Get Started', class: 'btn-primary', action: startSetup }]
            );
        }, 600);
    }
}

function startSetup() {
    state.pairs = [];
    state.questions = [];
    state.questionGroups = {};
    state.currentQuestionSetup = 0;
    state.questionCount = 0;
    state.setupStep = 'pairs';
    state.phase = 'setup';
    addMessage("Step 1 of 3: Trading Pairs\n\nEnter your pairs separated by commas.\n\nExample: EURUSD, GBPUSD, XAUUSD, USDJPY", true);
    showInput('Enter pairs (e.g., EURUSD, GBPUSD)');
}

function handleSetupInput(input) {
    if (state.setupStep === 'pairs') {
        const pairs = input.split(',').map(p => p.trim().toUpperCase()).filter(p => p.length > 0);
        if (pairs.length === 0) { addMessage("‚ùå Please enter at least one trading pair.", true); return; }
        state.pairs = pairs;
        state.setupStep = 'question-count';
        addMessage(`‚úÖ Pairs configured: ${pairs.join(', ')}`, true);
        setTimeout(() => {
            addMessage("Step 2 of 3: Questions\n\nHow many questions per pair? (Recommended: 3-5)", true);
            showInput('Enter number (e.g., 4)');
        }, 400);
    } else if (state.setupStep === 'question-count') {
        const count = parseInt(input);
        if (isNaN(count) || count < 1 || count > 10) { addMessage("‚ùå Please enter a number between 1 and 10.", true); return; }
        state.questionCount = count;
        state.setupStep = 'questions';
        state.currentQuestionSetup = 0;
        addMessage(`‚úÖ ${count} questions per pair.`, true);
        setTimeout(() => askForQuestion(), 400);
    } else if (state.setupStep === 'questions') {
        const questionText = input.trim();
        if (!questionText) { addMessage("‚ùå Please enter a question.", true); return; }
        state.questions.push(questionText);
        state.currentQuestionSetup++;
        if (state.currentQuestionSetup < state.questionCount) {
            addMessage(`‚úÖ Question ${state.currentQuestionSetup} saved!`, true);
            setTimeout(() => askForQuestion(), 400);
        } else {
            state.setupStep = 'groups';
            state.currentQuestionSetup = 0;
            addMessage(`‚úÖ All questions saved!`, true);
            setTimeout(() => askForAnswerGroup(), 400);
        }
    }
}

function askForQuestion() {
    const num = state.currentQuestionSetup + 1;
    addMessage(`Question ${num} of ${state.questionCount}\n\nWhat would you like to ask?\n\nTip: Use "quotes" to set the snapshot column header`, true);
    showInput(`Enter question ${num}...`);
}

function askForAnswerGroup() {
    if (state.currentQuestionSetup >= state.questions.length) { finishSetup(); return; }
    const questionText = state.questions[state.currentQuestionSetup];
    const num = state.currentQuestionSetup + 1;
    hideInput();
    addMessage(`Question ${num}: "${questionText}"\n\nWhich answer group?`, true);
    const allGroups = getAllGroups();
    const buttons = Object.keys(allGroups).map(key => ({
        text: `üìã ${allGroups[key].name}`,
        class: 'btn-verdict',
        action: () => showAnswerGroupPreview(key)
    }));
    addMessage('Choose one to preview its options:', true, buttons);
}

function showAnswerGroupPreview(groupKey) {
    const allGroups = getAllGroups();
    const group = allGroups[groupKey];
    if (!group) return;
    const msgs = chatContainer.querySelectorAll('.message');
    if (msgs.length >= 1) {
        const bg = msgs[msgs.length - 1].querySelector('.button-group');
        if (bg) bg.style.display = 'none';
    }
    const preview = group.answers.map(a => a.text).join(' ‚Ä¢ ');
    addMessage(`üìã ${group.name}\n\n${preview}\n\nUse this group?`, true, [
        { text: '‚úÖ Yes, use this', class: 'btn-primary', action: () => confirmAnswerGroup(groupKey) },
        { text: '‚Üê Choose different', class: 'btn-verdict', action: () => {
            const ms = chatContainer.querySelectorAll('.message');
            if (ms.length >= 1) { const bg = ms[ms.length-1].querySelector('.button-group'); if (bg) bg.style.display='none'; }
            askForAnswerGroup();
        }}
    ]);
}

function confirmAnswerGroup(groupKey) {
    state.questionGroups[state.currentQuestionSetup] = groupKey;
    const msgs = chatContainer.querySelectorAll('.message');
    if (msgs.length >= 1) {
        const bg = msgs[msgs.length-1].querySelector('.button-group');
        if (bg) bg.style.display = 'none';
    }
    state.currentQuestionSetup++;
    const allGroups = getAllGroups();
    addMessage(`‚úÖ "${allGroups[groupKey].name}" selected!`, true);
    setTimeout(() => askForAnswerGroup(), 400);
}

function finishSetup() {
    saveConfig();
    state.phase = 'configured';
    hideInput();
    addMessage('üéâ Your framework is configured!', true);
    setTimeout(() => {
        const allGroups = getAllGroups();
        let summary = `üìã Your Setup:\n\nPairs: ${state.pairs.join(', ')}\n\nQuestions:\n`;
        state.questions.forEach((q, i) => {
            const gk = state.questionGroups[i];
            const gn = allGroups[gk] ? allGroups[gk].name : gk;
            summary += `${i+1}. ${q} (${gn})\n`;
        });
        addMessage(summary, true, [{ text: '‚ñ∂ Start First Session', class: 'btn-primary', action: startSession }]);
    }, 400);
}

// ============================================
// SESSION FLOW
// ============================================
function resumeDraft() {
    const draft = loadDraft();
    if (!draft) { startSession(); return; }
    state.phase = 'session';
    state.timestamp = draft.timestamp;
    state.currentPairIndex = draft.currentPairIndex;
    state.currentQuestionIndex = draft.currentQuestionIndex;
    state.answers = draft.answers || {};
    state.answerHistory = draft.answerHistory || [];
    backBtn.classList.add('show');
    clearChat();
    // Show a brief recap of what was already answered
    const completedPairs = Object.keys(state.answers).filter(p => (state.answers[p]||[]).length === state.questions.length);
    let recapMsg = `‚ñ∂ Resuming session from ${state.timestamp}\n\n`;
    if (completedPairs.length > 0) recapMsg += `‚úì Completed: ${completedPairs.join(', ')}\n\n`;
    recapMsg += `Continuing with ${state.pairs[state.currentPairIndex]}...`;
    addMessage(recapMsg, true);
    forceScrollToAnchor();
    setTimeout(() => askNextQuestion(), 700);
}

function startSession() {
    clearDraft(); // discard any old unfinished session
    state.phase = 'session';
    state.currentPairIndex = 0;
    state.currentQuestionIndex = 0;
    state.answers = {};
    state.answerHistory = [];
    state.timestamp = new Date().toLocaleString('en-GB', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit', hour12: false
    });
    saveDraft(); // save immediately so even 0-answer sessions are recoverable
    addMessage("‚úÖ Session started!\n\nAnswer each question thoughtfully.\n\nRemember: If you're rushing, that's your signal to pause.", true);
    backBtn.classList.add('show');
    forceScrollToAnchor();
    setTimeout(() => askNextQuestion(), 700);
}

function askNextQuestion() {
    if (state.currentPairIndex >= state.pairs.length) { generateSnapshot(); return; }
    const pair = state.pairs[state.currentPairIndex];
    const question = state.questions[state.currentQuestionIndex];
    const groupKey = state.questionGroups[state.currentQuestionIndex];
    const allGroups = getAllGroups();
    const answerGroup = allGroups[groupKey];
    if (!state.answers[pair]) state.answers[pair] = [];
    const buttons = answerGroup.answers.map(answer => ({
        text: answer.text,
        class: `btn-verdict ${answer.class}`,
        action: () => handleAnswer(answer.text)
    }));
    addMessage(`üí° ${pair}\n\n${question}:`, true, buttons);
    hideInput();
}

function handleAnswer(answer) {
    const pair = state.pairs[state.currentPairIndex];
    state.answerHistory.push({
        pairIndex: state.currentPairIndex,
        questionIndex: state.currentQuestionIndex,
        answer
    });
    state.answers[pair].push(answer);
    addMessage(answer, false);
    const messages = chatContainer.querySelectorAll('.message');
    if (messages.length >= 2) {
        const bg = messages[messages.length - 2].querySelector('.button-group');
        if (bg) bg.style.display = 'none';
    }
    state.currentQuestionIndex++;
    if (state.currentQuestionIndex >= state.questions.length) {
        state.currentPairIndex++;
        state.currentQuestionIndex = 0;
        if (state.currentPairIndex < state.pairs.length) {
            saveDraft(); // save progress after completing a pair
            setTimeout(() => {
                addMessage(`‚úì ${pair} complete\n\n‚Üí Moving to ${state.pairs[state.currentPairIndex]}`, true);
                setTimeout(askNextQuestion, 500);
            }, 300);
            return;
        }
    } else {
        saveDraft(); // save progress after every single answer
    }
    setTimeout(askNextQuestion, 300);
}

// Back one question
backBtn.addEventListener('click', () => {
    if (state.phase !== 'session' || state.answerHistory.length === 0) return;
    const last = state.answerHistory.pop();
    const pair = state.pairs[last.pairIndex];
    if (state.answers[pair] && state.answers[pair].length > 0) state.answers[pair].pop();
    state.currentPairIndex = last.pairIndex;
    state.currentQuestionIndex = last.questionIndex;
    const messages = chatContainer.querySelectorAll('.message');
    if (messages.length >= 1) messages[messages.length - 1].remove();
    if (messages.length >= 2) messages[messages.length - 2].remove();
    setTimeout(() => askNextQuestion(), 100);
});

// ============================================
// SNAPSHOT GENERATION
// ============================================
function generateSnapshot() {
    backBtn.classList.remove('show');
    clearDraft(); // session complete ‚Äî remove the draft
    addMessage("‚úÖ Checklist completed!\n\nGenerating your trading snapshot...", true);
    showLoading();
    setTimeout(() => {
        hideLoading();
        const canvas = createSnapshotCanvas();
        const dataURL = canvas.toDataURL('image/png');

        // Save session to history
        const sessionData = {
            timestamp: state.timestamp,
            pairs: [...state.pairs],
            questions: [...state.questions],
            answers: JSON.parse(JSON.stringify(state.answers)),
            snapshot: dataURL
        };
        saveSession(sessionData);

        const messageDiv = document.createElement('div');
        messageDiv.className = 'message message-bot';
        messageDiv.innerHTML = `
            <div class="message-content">
                <div class="message-label">Trading Partner</div>
                <div class="message-bubble">
                    üì∏ Your Trading Plan Snapshot ‚Äî saved to history!
                    <div class="snapshot-container">
                        <img src="${dataURL}" class="snapshot-image" id="snapshotImg" alt="Trading Plan">
                        <div class="snapshot-actions">
                            <button class="btn btn-primary" id="downloadBtn">üíæ Download</button>
                            <button class="btn btn-verdict" id="newSessionBtn">üîÑ New Session</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        const anchor = document.getElementById('scrollAnchor');
        chatContainer.insertBefore(messageDiv, anchor);
        scrollToAnchor();

        document.getElementById('downloadBtn').onclick = () => downloadSnapshot(dataURL);
        document.getElementById('newSessionBtn').onclick = startSession;
        document.getElementById('snapshotImg').onclick = () => viewFullscreen(dataURL);
    }, 1200);
}

function createSnapshotCanvas() {
    // ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PADDING        = 60;
    const CELL_PAD_H     = 24;    // horizontal padding inside each cell (left side only)
    const CELL_PAD_V     = 14;    // vertical padding top+bottom inside each cell
    const LINE_HEIGHT    = 19;    // px between lines when text wraps
    const TEXT_HEIGHT    = 17;    // approximate cap height of 15px monospace
    const HEADER_HEIGHT  = 180;
    const FOOTER_HEIGHT  = 60;
    const FONT_HEADER    = 'bold 15px monospace';
    const FONT_CELL      = 'bold 15px monospace';
    const FONT_PAIR      = '15px monospace';
    const MIN_COL_W      = 120;   // minimum answer column width ‚Äî wrapping handles the rest
    const MIN_PAIR_W     = 110;
    const MAX_WRAP_LINES = 2;     // never more than 2 lines per cell

    const COLORS = {
        bgPrimary:    '#0A0E27',
        bgHeader:     '#1A1F3A',
        bgRowAlt:     '#111628',
        accentCyan:   '#00D9FF',
        accentPurple: '#7B61FF',
        textPrimary:  '#FFFFFF',
        textSecondary:'#B8C5D6',
        border:       '#2D3548',
        buy:          '#00FF94',
        sell:         '#FF4757',
        standby:      '#FFB800'
    };

    function colorFor(answer) {
        if (/üìà|‚¨ÜÔ∏è|‚ñ≤|üî•|üåÖ|Bullish|Buy|HL\/HH|Ext\. Above|Extending Up|Tgt\. Ext\. A|‚Üí Ext\. Above/.test(answer)) return COLORS.buy;
        if (/üìâ|‚¨áÔ∏è|‚ñº|‚ùÑÔ∏è|üåë|Bearish|Sell|LH\/LL|Ext\. Below|Extending Down|‚Üí Ext\. Below/.test(answer)) return COLORS.sell;
        if (/‚ÜîÔ∏è|‚û°Ô∏è|üîÑ|‚ö°|üå§Ô∏è|üå•Ô∏è|Sideways|Stand by|Choppy|Fading|Shifting|Exhausted|Mixed|No Clear|Targeting Int\./.test(answer)) return COLORS.standby;
        return COLORS.textSecondary;
    }

    // ‚îÄ‚îÄ SCRATCH CANVAS for measuring ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const scratch = document.createElement('canvas');
    const sCtx = scratch.getContext('2d');

    // Split text into up to MAX_WRAP_LINES lines given a max pixel width
    function wrapText(ctx, text, maxW) {
        // First try fitting on one line
        if (ctx.measureText(text).width <= maxW) return [text];

        // Try to split on word boundaries
        const words = text.split(' ');
        const lines = [];
        let current = '';

        for (const word of words) {
            const test = current ? current + ' ' + word : word;
            if (ctx.measureText(test).width > maxW && current) {
                lines.push(current);
                current = word;
                if (lines.length === MAX_WRAP_LINES) break;
            } else {
                current = test;
            }
        }
        if (current && lines.length < MAX_WRAP_LINES) lines.push(current);

        // If we still only have 1 line (single long word with no spaces), just return it ‚Äî no hard truncation
        return lines.length ? lines : [text];
    }

    // Height a cell needs given its text and column width
    function cellHeight(ctx, font, text, colW) {
        ctx.font = font;
        const usableW = colW - CELL_PAD_H * 2;
        const lines = wrapText(ctx, text, usableW);
        const numLines = Math.min(lines.length, MAX_WRAP_LINES);
        return CELL_PAD_V * 2 + TEXT_HEIGHT + (numLines - 1) * LINE_HEIGHT;
    }

    // ‚îÄ‚îÄ PHASE 1: DETERMINE COLUMN WIDTHS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Column width is based on fitting the HEADER in one line (headers shouldn't wrap)
    // plus a comfortable minimum. Answer cells will wrap if needed within that width.

    sCtx.font = FONT_HEADER;
    let pairColW = sCtx.measureText('PAIR').width + CELL_PAD_H * 2;
    sCtx.font = FONT_PAIR;
    for (const pair of state.pairs) {
        pairColW = Math.max(pairColW, sCtx.measureText(pair).width + CELL_PAD_H * 2);
    }
    pairColW = Math.max(pairColW, MIN_PAIR_W);

    const colWidths = state.questions.map((question) => {
        const quoted = question.match(/"([^"]+)"/);
        const headerText = (quoted ? quoted[1] : question).toUpperCase();
        sCtx.font = FONT_HEADER;
        // Column wide enough for the header to fit on one line
        const w = sCtx.measureText(headerText).width + CELL_PAD_H * 2;
        return Math.max(w, MIN_COL_W);
    });

    // ‚îÄ‚îÄ PHASE 2: DETERMINE PER-ROW HEIGHTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Each row's height = tallest cell in that row (pair name or any answer).
    // The column header row height is determined by the tallest header.

    // Header row height ‚Äî headers fit in one line by design, but check just in case
    let headerRowH = CELL_PAD_V * 2 + TEXT_HEIGHT; // default: 1-line height
    state.questions.forEach((question, i) => {
        const quoted = question.match(/"([^"]+)"/);
        const headerText = (quoted ? quoted[1] : question).toUpperCase();
        const h = cellHeight(sCtx, FONT_HEADER, headerText, colWidths[i]);
        headerRowH = Math.max(headerRowH, h);
    });

    // Data row heights
    const rowHeights = state.pairs.map((pair) => {
        // Height needed for the pair name cell
        let maxH = cellHeight(sCtx, FONT_PAIR, pair, pairColW);
        // Height needed for each answer cell
        state.questions.forEach((_, qIdx) => {
            const answer = (state.answers[pair] || [])[qIdx] || '';
            const h = cellHeight(sCtx, FONT_CELL, answer, colWidths[qIdx]);
            maxH = Math.max(maxH, h);
        });
        return maxH;
    });

    // ‚îÄ‚îÄ PHASE 3: CANVAS SIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const tableWidth  = pairColW + colWidths.reduce((s, w) => s + w, 0);
    const tableHeight = headerRowH + rowHeights.reduce((s, h) => s + h, 0);

    const canvasWidth  = Math.max(tableWidth + PADDING * 2, 700);
    const canvasHeight = PADDING + HEADER_HEIGHT + tableHeight + FOOTER_HEIGHT + PADDING;

    // ‚îÄ‚îÄ PHASE 4: DRAW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const canvas = document.createElement('canvas');
    canvas.width  = canvasWidth;
    canvas.height = canvasHeight;
    const ctx = canvas.getContext('2d');

    ctx.fillStyle = COLORS.bgPrimary;
    ctx.fillRect(0, 0, canvasWidth, canvasHeight);

    let currentY = PADDING;
    const tableX = Math.round((canvasWidth - tableWidth) / 2);

    // Helper: draw wrapped text centred vertically in a cell of given height
    function drawCellText(text, font, color, x, cellY, cellH, colW) {
        ctx.font = font;
        ctx.fillStyle = color;
        ctx.textAlign = 'left';
        const usableW = colW - CELL_PAD_H * 2;
        const lines = wrapText(ctx, text, usableW).slice(0, MAX_WRAP_LINES);
        const blockH = TEXT_HEIGHT + (lines.length - 1) * LINE_HEIGHT;
        // vertically centre the text block inside the cell
        const startY = cellY + Math.round((cellH - blockH) / 2) + TEXT_HEIGHT;
        lines.forEach((line, li) => {
            ctx.fillText(line, x + CELL_PAD_H, startY + li * LINE_HEIGHT);
        });
    }

    // ‚îÄ‚îÄ HEADER BANNER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.fillStyle = COLORS.bgHeader;
    ctx.fillRect(tableX, currentY, tableWidth, HEADER_HEIGHT);

    const gradTop = ctx.createLinearGradient(tableX, 0, tableX + tableWidth, 0);
    gradTop.addColorStop(0, COLORS.accentCyan);
    gradTop.addColorStop(1, COLORS.accentPurple);
    ctx.fillStyle = gradTop;
    ctx.fillRect(tableX, currentY, tableWidth, 4);

    ctx.fillStyle = COLORS.textPrimary;
    ctx.font = 'bold 34px serif';
    ctx.textAlign = 'center';
    ctx.fillText('TRADING PLAN SNAPSHOT', canvasWidth / 2, currentY + 60);

    ctx.fillStyle = COLORS.accentCyan;
    ctx.font = '17px monospace';
    ctx.fillText(state.timestamp, canvasWidth / 2, currentY + 100);

    ctx.fillStyle = COLORS.accentPurple;
    ctx.fillRect(canvasWidth / 2 - 50, currentY + 118, 100, 2);

    ctx.fillStyle = COLORS.textSecondary;
    ctx.font = '13px monospace';
    ctx.fillText(
        `${state.pairs.length} pair${state.pairs.length !== 1 ? 's' : ''} ¬∑ ${state.questions.length} factor${state.questions.length !== 1 ? 's' : ''}`,
        canvasWidth / 2, currentY + 145
    );

    currentY += HEADER_HEIGHT;

    // ‚îÄ‚îÄ COLUMN HEADER ROW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    ctx.fillStyle = COLORS.bgHeader;
    ctx.fillRect(tableX, currentY, tableWidth, headerRowH);

    ctx.fillStyle = gradTop;
    ctx.fillRect(tableX, currentY, tableWidth, 2);

    let colX = tableX;

    // "PAIR" header
    drawCellText('PAIR', FONT_HEADER, COLORS.accentCyan, colX, currentY, headerRowH, pairColW);
    colX += pairColW;

    ctx.fillStyle = COLORS.border;
    ctx.fillRect(colX, currentY + 8, 1, headerRowH - 16);

    state.questions.forEach((question, i) => {
        const quoted = question.match(/"([^"]+)"/);
        const headerText = (quoted ? quoted[1] : question).toUpperCase();
        drawCellText(headerText, FONT_HEADER, COLORS.accentCyan, colX, currentY, headerRowH, colWidths[i]);
        colX += colWidths[i];
        if (i < state.questions.length - 1) {
            ctx.fillStyle = COLORS.border;
            ctx.fillRect(colX, currentY + 8, 1, headerRowH - 16);
        }
    });

    ctx.fillStyle = COLORS.border;
    ctx.fillRect(tableX, currentY + headerRowH - 1, tableWidth, 1);

    currentY += headerRowH;

    // ‚îÄ‚îÄ DATA ROWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    state.pairs.forEach((pair, rowIdx) => {
        const rowH = rowHeights[rowIdx];

        if (rowIdx % 2 === 0) {
            ctx.fillStyle = COLORS.bgRowAlt;
            ctx.fillRect(tableX, currentY, tableWidth, rowH);
        }

        colX = tableX;

        // Pair name
        drawCellText(pair, FONT_PAIR, COLORS.textPrimary, colX, currentY, rowH, pairColW);
        colX += pairColW;

        ctx.fillStyle = COLORS.border;
        ctx.fillRect(colX, currentY + 8, 1, rowH - 16);

        // Answer cells
        (state.answers[pair] || []).forEach((answer, ansIdx) => {
            drawCellText(answer, FONT_CELL, colorFor(answer), colX, currentY, rowH, colWidths[ansIdx]);
            colX += colWidths[ansIdx];
            if (ansIdx < state.questions.length - 1) {
                ctx.fillStyle = COLORS.border;
                ctx.fillRect(colX, currentY + 8, 1, rowH - 16);
            }
        });

        ctx.fillStyle = COLORS.border;
        ctx.fillRect(tableX, currentY + rowH - 1, tableWidth, 1);

        currentY += rowH;
    });

    // Outer table border
    ctx.strokeStyle = COLORS.border;
    ctx.lineWidth = 1;
    ctx.strokeRect(tableX, PADDING + HEADER_HEIGHT, tableWidth, tableHeight);

    // ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const gradBot = ctx.createLinearGradient(tableX, 0, tableX + tableWidth, 0);
    gradBot.addColorStop(0, COLORS.accentCyan);
    gradBot.addColorStop(1, COLORS.accentPurple);
    ctx.fillStyle = gradBot;
    ctx.fillRect(tableX, currentY + 10, tableWidth, 2);

    ctx.fillStyle = COLORS.textSecondary;
    ctx.font = '13px monospace';
    ctx.textAlign = 'center';
    ctx.fillText(
        'Trade with discipline. Protect your capital. Trust your process.',
        canvasWidth / 2, currentY + 38
    );

    return canvas;
}

function downloadSnapshot(dataURL) {
    try {
        const link = document.createElement('a');
        link.download = `trading-plan-${new Date().toISOString().slice(0,10)}.png`;
        link.href = dataURL;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
        setTimeout(() => addMessage("‚úÖ Snapshot downloaded!", true), 300);
    } catch(e) { window.open(dataURL, '_blank'); }
}

function viewFullscreen(dataURL) {
    const overlay = document.createElement('div');
    overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.96);display:flex;align-items:center;justify-content:center;z-index:9999;cursor:pointer;';
    overlay.innerHTML = `<img src="${dataURL}" style="max-width:95%;max-height:95%;box-shadow:0 0 50px rgba(0,217,255,0.3);">`;
    overlay.onclick = () => overlay.remove();
    document.body.appendChild(overlay);
}

// ============================================
// HISTORY PANEL
// ============================================
document.getElementById('historyBtn').addEventListener('click', openHistory);
document.getElementById('closeHistoryBtn').addEventListener('click', () => historyOverlay.classList.remove('show'));

function openHistory() {
    renderHistory();
    historyOverlay.classList.add('show');
}

function renderHistory() {
    const sessions = loadSessions();
    const content = document.getElementById('historyContent');
    if (sessions.length === 0) {
        content.innerHTML = '<div class="history-empty">üì≠ No sessions saved yet.<br><br>Complete a session to see it here.</div>';
        return;
    }
    content.innerHTML = '';
    sessions.forEach((session, idx) => {
        const card = document.createElement('div');
        card.className = 'history-session-detail';
        const numCols = (session.questions||[]).length;
        let gridHTML = `<div class="history-answers-grid" style="--num-cols:${numCols}">`;
        // Headers
        gridHTML += `<div class="grid-header">Pair</div>`;
        (session.questions||[]).forEach(q => {
            const quoted = q.match(/"([^"]+)"/);
            gridHTML += `<div class="grid-header">${quoted ? quoted[1] : q}</div>`;
        });
        // Rows
        (session.pairs||[]).forEach(pair => {
            gridHTML += `<div class="grid-cell pair-cell">${pair}</div>`;
            const answers = (session.answers||{})[pair] || [];
            answers.forEach(answer => {
                let cls = '';
                if (answer.includes('üìà')||answer.includes('‚¨ÜÔ∏è')||answer.includes('‚ñ≤')||answer.includes('Bullish')||answer.includes('Buy')||answer.includes('HL/HH')) cls='buy-cell';
                else if (answer.includes('üìâ')||answer.includes('‚¨áÔ∏è')||answer.includes('‚ñº')||answer.includes('Bearish')||answer.includes('Sell')||answer.includes('LH/LL')) cls='sell-cell';
                else if (answer.includes('‚ÜîÔ∏è')||answer.includes('Stand by')||answer.includes('Sideways')||answer.includes('Fading')||answer.includes('Shifting')) cls='standby-cell';
                gridHTML += `<div class="grid-cell ${cls}">${answer}</div>`;
            });
        });
        gridHTML += '</div>';

        card.innerHTML = `
            <div class="history-session-meta">
                <div class="history-session-time">üìÖ ${session.timestamp}</div>
                <div class="history-session-actions">
                    ${session.snapshot ? `<button class="session-view-btn" onclick="viewSnapshotFromHistory('${idx}')">üñº View</button>` : ''}
                    ${session.snapshot ? `<button class="session-view-btn" onclick="downloadSnapshotFromHistory('${idx}')">üíæ</button>` : ''}
                    <button class="session-delete-btn" onclick="removeSession(${idx})">üóë</button>
                </div>
            </div>
            ${gridHTML}
        `;
        content.appendChild(card);
    });
}

window.viewSnapshotFromHistory = function(idx) {
    const sessions = loadSessions();
    if (sessions[idx] && sessions[idx].snapshot) viewFullscreen(sessions[idx].snapshot);
};

window.downloadSnapshotFromHistory = function(idx) {
    const sessions = loadSessions();
    if (sessions[idx] && sessions[idx].snapshot) downloadSnapshot(sessions[idx].snapshot);
};

window.removeSession = function(idx) {
    if (!confirm('Delete this session?')) return;
    deleteSession(idx);
    renderHistory();
};

// ============================================
// SETTINGS PANEL ‚Äî TABS
// ============================================
document.querySelectorAll('.settings-tab').forEach(tab => {
    tab.addEventListener('click', function() {
        document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        document.getElementById('tab-' + this.dataset.tab).classList.add('active');
    });
});

document.getElementById('settingsBtn').addEventListener('click', openSettings);
document.getElementById('closeSettingsBtn').addEventListener('click', closeSettings);
document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);

let tempPairs = [], tempQuestions = [], tempQuestionGroups = {}, tempCustomGroups = {};

function openSettings() {
    tempPairs = [...state.pairs];
    tempQuestions = [...state.questions];
    tempQuestionGroups = {...state.questionGroups};
    tempCustomGroups = JSON.parse(JSON.stringify(loadCustomGroups()));
    renderSettings();
    settingsOverlay.classList.add('show');
}

function closeSettings() {
    settingsOverlay.classList.remove('show');
}

function saveSettings() {
    if (tempPairs.length === 0) { alert('‚ö†Ô∏è Add at least one pair'); return; }
    if (tempQuestions.length === 0) { alert('‚ö†Ô∏è Add at least one question'); return; }
    state.pairs = tempPairs;
    state.questions = tempQuestions;
    state.questionGroups = tempQuestionGroups;
    saveCustomGroups(tempCustomGroups);
    state.customGroups = tempCustomGroups;
    saveConfig();
    state.phase = 'welcome-back';
    closeSettings();
    addMessage('‚úÖ Configuration saved!', true);
    showWelcome();
}

function renderSettings() {
    renderPairs();
    renderQuestions();
    renderAnswerGroups();
}

function renderPairs() {
    const list = document.getElementById('pairsList');
    list.innerHTML = '';
    if (tempPairs.length === 0) {
        list.innerHTML = '<div style="color:var(--text-secondary);text-align:center;padding:16px">No pairs configured</div>';
        return;
    }
    tempPairs.forEach((pair, i) => {
        const item = document.createElement('div');
        item.className = 'config-item';
        item.innerHTML = `
            <div class="config-item-content"><div class="config-item-text">${pair}</div></div>
            <div class="config-item-actions">
                <button class="icon-btn" ${i===0?'disabled style="opacity:.3"':''} onclick="movePairUp(${i})">‚Üë</button>
                <button class="icon-btn" ${i===tempPairs.length-1?'disabled style="opacity:.3"':''} onclick="movePairDown(${i})">‚Üì</button>
                <button class="icon-btn edit" onclick="editPair(${i})">‚úèÔ∏è</button>
                <button class="icon-btn delete" onclick="deletePair(${i})">üóëÔ∏è</button>
            </div>
        `;
        list.appendChild(item);
    });
}

function renderQuestions() {
    const list = document.getElementById('questionsList');
    list.innerHTML = '';
    if (tempQuestions.length === 0) {
        list.innerHTML = '<div style="color:var(--text-secondary);text-align:center;padding:16px">No questions configured</div>';
        return;
    }
    const allGroups = { ...BUILTIN_GROUPS, ...tempCustomGroups };
    tempQuestions.forEach((q, i) => {
        const gk = tempQuestionGroups[i];
        const gn = allGroups[gk] ? allGroups[gk].name : 'Not set';
        const item = document.createElement('div');
        item.className = 'config-item';
        item.innerHTML = `
            <div class="config-item-content">
                <div class="config-item-text">${i+1}. ${q}</div>
                <div class="config-item-meta">Answer Group: ${gn}</div>
            </div>
            <div class="config-item-actions">
                <button class="icon-btn" ${i===0?'disabled style="opacity:.3"':''} onclick="moveQuestionUp(${i})">‚Üë</button>
                <button class="icon-btn" ${i===tempQuestions.length-1?'disabled style="opacity:.3"':''} onclick="moveQuestionDown(${i})">‚Üì</button>
                <button class="icon-btn edit" onclick="editQuestion(${i})">‚úèÔ∏è</button>
                <button class="icon-btn delete" onclick="deleteQuestion(${i})">üóëÔ∏è</button>
            </div>
        `;
        list.appendChild(item);
    });
}

function renderAnswerGroups() {
    // Builtin (read-only)
    const builtinList = document.getElementById('builtinGroupsList');
    builtinList.innerHTML = '';
    Object.keys(BUILTIN_GROUPS).forEach(key => {
        const g = BUILTIN_GROUPS[key];
        const card = document.createElement('div');
        card.className = 'answer-group-card';
        card.style.opacity = '0.7';
        card.innerHTML = `
            <div class="answer-group-header">
                <div class="answer-group-name">${g.name} <span style="font-size:10px;color:var(--text-secondary)">(built-in)</span></div>
            </div>
            <div class="answer-tags">${g.answers.map(a=>`<div class="answer-tag ${a.class}">${a.text}</div>`).join('')}</div>
        `;
        builtinList.appendChild(card);
    });

    // Custom groups
    const customList = document.getElementById('customGroupsList');
    customList.innerHTML = '';
    const keys = Object.keys(tempCustomGroups);
    if (keys.length === 0) {
        customList.innerHTML = '<div style="color:var(--text-secondary);font-size:12px;padding:8px 0 12px">No custom groups yet.</div>';
    }
    keys.forEach(key => {
        const g = tempCustomGroups[key];
        const card = document.createElement('div');
        card.className = 'answer-group-card';
        card.innerHTML = `
            <div class="answer-group-header">
                <div class="answer-group-name">‚ú® ${g.name}</div>
                <div style="display:flex;gap:6px">
                    <button class="icon-btn edit" onclick="editCustomGroup('${key}')">‚úèÔ∏è</button>
                    <button class="icon-btn delete" onclick="deleteCustomGroup('${key}')">üóëÔ∏è</button>
                </div>
            </div>
            <div class="answer-tags">${(g.answers||[]).map(a=>`<div class="answer-tag ${a.class}">${a.text}</div>`).join('')}</div>
        `;
        customList.appendChild(card);
    });
}

// Pair actions
window.movePairUp = i => { if(i>0){const t=tempPairs[i];tempPairs[i]=tempPairs[i-1];tempPairs[i-1]=t;renderPairs();} };
window.movePairDown = i => { if(i<tempPairs.length-1){const t=tempPairs[i];tempPairs[i]=tempPairs[i+1];tempPairs[i+1]=t;renderPairs();} };
window.editPair = i => showEditForm('pair', i, tempPairs[i]);
window.deletePair = i => { if(confirm(`Delete "${tempPairs[i]}"?`)){tempPairs.splice(i,1);renderPairs();} };

// Question actions
window.moveQuestionUp = i => {
    if(i>0){const t=tempQuestions[i];tempQuestions[i]=tempQuestions[i-1];tempQuestions[i-1]=t;const tg=tempQuestionGroups[i];tempQuestionGroups[i]=tempQuestionGroups[i-1];tempQuestionGroups[i-1]=tg;renderQuestions();}
};
window.moveQuestionDown = i => {
    if(i<tempQuestions.length-1){const t=tempQuestions[i];tempQuestions[i]=tempQuestions[i+1];tempQuestions[i+1]=t;const tg=tempQuestionGroups[i];tempQuestionGroups[i]=tempQuestionGroups[i+1];tempQuestionGroups[i+1]=tg;renderQuestions();}
};
window.editQuestion = i => showEditForm('question', i, tempQuestions[i], tempQuestionGroups[i]);
window.deleteQuestion = i => {
    if(confirm(`Delete question "${tempQuestions[i]}"?`)){
        tempQuestions.splice(i,1);
        const ng={};Object.keys(tempQuestionGroups).forEach(k=>{const idx=parseInt(k);if(idx<i)ng[idx]=tempQuestionGroups[idx];else if(idx>i)ng[idx-1]=tempQuestionGroups[idx];});
        tempQuestionGroups=ng;renderQuestions();
    }
};

// Custom group actions
window.editCustomGroup = key => showCustomGroupForm(key, tempCustomGroups[key]);
window.deleteCustomGroup = key => {
    if(confirm(`Delete custom group "${tempCustomGroups[key].name}"?`)){
        delete tempCustomGroups[key];
        renderAnswerGroups();
    }
};

document.getElementById('addPairBtn').addEventListener('click', () => showEditForm('pair', -1, ''));
document.getElementById('addQuestionBtn').addEventListener('click', () => showEditForm('question', -1, '', 'bias'));
document.getElementById('addCustomGroupBtn').addEventListener('click', () => showCustomGroupForm(null, null));

// ============================================
// EDIT FORMS
// ============================================
function showEditForm(type, index, value, groupKey = null) {
    editForm.innerHTML = '';
    if (type === 'pair') {
        editForm.innerHTML = `
            <div class="edit-form-title">${index===-1?'Add':'Edit'} Trading Pair</div>
            <div class="form-group">
                <label class="form-label">Pair Symbol</label>
                <input type="text" class="form-input" id="editInput" value="${value}" placeholder="e.g., EURUSD">
            </div>
            <div class="form-actions">
                <button class="form-btn cancel" onclick="closeEditForm()">Cancel</button>
                <button class="form-btn save" onclick="savePairEdit(${index})">Save</button>
            </div>
        `;
    } else {
        const allGroups = { ...BUILTIN_GROUPS, ...tempCustomGroups };
        const options = Object.keys(allGroups).map(k => `<option value="${k}" ${k===groupKey?'selected':''}>${allGroups[k].name}${k in tempCustomGroups?' ‚ú®':''}</option>`).join('');
        editForm.innerHTML = `
            <div class="edit-form-title">${index===-1?'Add':'Edit'} Question</div>
            <div class="form-group">
                <label class="form-label">Question Text</label>
                <input type="text" class="form-input" id="editInput" value="${value}" placeholder='e.g., What is your "Daily Bias"?'>
                <div class="form-hint">Use "quotes" to set the snapshot column header</div>
            </div>
            <div class="form-group">
                <label class="form-label">Answer Group</label>
                <select class="form-select" id="editGroup">${options}</select>
            </div>
            <div class="form-actions">
                <button class="form-btn cancel" onclick="closeEditForm()">Cancel</button>
                <button class="form-btn save" onclick="saveQuestionEdit(${index})">Save</button>
            </div>
        `;
    }
    editModal.classList.add('show');
    setTimeout(() => document.getElementById('editInput') && document.getElementById('editInput').focus(), 100);
}

function showCustomGroupForm(existingKey, existingGroup) {
    const isNew = existingKey === null;
    const answers = existingGroup ? existingGroup.answers : [{ text: '', class: '' }];

    editForm.innerHTML = `
        <div class="edit-form-title">${isNew ? 'Create' : 'Edit'} Custom Answer Group</div>
        <div class="form-group">
            <label class="form-label">Group Name</label>
            <input type="text" class="form-input" id="groupNameInput" value="${existingGroup ? existingGroup.name : ''}" placeholder="e.g., My Setup Conditions">
        </div>
        <div class="form-group">
            <label class="form-label">Answer Options</label>
            <div class="answer-builder" id="answerBuilder"></div>
            <button type="button" class="add-answer-row-btn" id="addAnswerRowBtn" style="width:100%;margin-top:8px">+ Add Answer</button>
        </div>
        <div class="form-actions">
            <button class="form-btn cancel" onclick="closeEditForm()">Cancel</button>
            <button class="form-btn save" onclick="saveCustomGroup('${existingKey||''}', ${isNew})">Save Group</button>
        </div>
    `;
    editModal.classList.add('show');

    const builder = document.getElementById('answerBuilder');
    function addAnswerRow(text='', cls='') {
        const row = document.createElement('div');
        row.className = 'answer-builder-row';
        row.innerHTML = `
            <input type="text" placeholder="Answer text (e.g., üî• Strong Confluence)" value="${text.replace(/"/g,'&quot;')}">
            <select class="answer-color-select">
                <option value="" ${cls===''?'selected':''}>‚¨ú Neutral</option>
                <option value="buy" ${cls==='buy'?'selected':''}>üü¢ Buy</option>
                <option value="sell" ${cls==='sell'?'selected':''}>üî¥ Sell</option>
                <option value="standby" ${cls==='standby'?'selected':''}>üü° Standby</option>
            </select>
            <button type="button" class="answer-remove-btn" onclick="this.parentElement.remove()">‚úï</button>
        `;
        builder.appendChild(row);
    }

    answers.forEach(a => addAnswerRow(a.text, a.class));
    document.getElementById('addAnswerRowBtn').addEventListener('click', () => addAnswerRow());
    setTimeout(() => document.getElementById('groupNameInput').focus(), 100);
}

window.saveCustomGroup = function(existingKey, isNew) {
    const nameInput = document.getElementById('groupNameInput');
    const name = nameInput.value.trim();
    if (!name) { alert('‚ö†Ô∏è Please enter a group name'); return; }
    const rows = document.querySelectorAll('#answerBuilder .answer-builder-row');
    const answers = [];
    rows.forEach(row => {
        const text = row.querySelector('input').value.trim();
        const cls = row.querySelector('select').value;
        if (text) answers.push({ text, class: cls });
    });
    if (answers.length === 0) { alert('‚ö†Ô∏è Add at least one answer option'); return; }
    const key = isNew ? 'custom_' + Date.now() : existingKey;
    tempCustomGroups[key] = { name, answers };
    renderAnswerGroups();
    closeEditForm();
};

window.closeEditForm = function() { editModal.classList.remove('show'); };

window.savePairEdit = function(index) {
    const v = document.getElementById('editInput').value.trim().toUpperCase();
    if (!v) { alert('‚ö†Ô∏è Please enter a pair symbol'); return; }
    if (index === -1) tempPairs.push(v); else tempPairs[index] = v;
    renderPairs(); closeEditForm();
};

window.saveQuestionEdit = function(index) {
    const v = document.getElementById('editInput').value.trim();
    const g = document.getElementById('editGroup').value;
    if (!v) { alert('‚ö†Ô∏è Please enter a question'); return; }
    if (index === -1) { tempQuestions.push(v); tempQuestionGroups[tempQuestions.length-1] = g; }
    else { tempQuestions[index] = v; tempQuestionGroups[index] = g; }
    renderQuestions(); closeEditForm();
};

// ============================================
// IMPORT / EXPORT / CLEAR
// ============================================
document.getElementById('exportBtn').addEventListener('click', () => {
    const config = {
        version: '2.0',
        timestamp: new Date().toISOString(),
        pairs: tempPairs,
        questions: tempQuestions.map((q, i) => ({ text: q, group: tempQuestionGroups[i] })),
        customGroups: tempCustomGroups
    };
    const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.download = `trading_config_${new Date().toISOString().slice(0,10)}.json`;
    link.href = url;
    document.body.appendChild(link); link.click(); document.body.removeChild(link);
    URL.revokeObjectURL(url);
    addMessage('üì§ Configuration exported!', true);
});

document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFileInput').click());

document.getElementById('importFileInput').addEventListener('change', e => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        try {
            const config = JSON.parse(ev.target.result);
            if (!config.pairs || !Array.isArray(config.pairs)) throw new Error('pairs missing');
            if (!config.questions || !Array.isArray(config.questions)) throw new Error('questions missing');
            tempPairs = config.pairs;
            tempQuestions = []; tempQuestionGroups = {};
            config.questions.forEach((q, i) => { tempQuestions.push(q.text); tempQuestionGroups[i] = q.group || 'bias'; });
            if (config.customGroups) tempCustomGroups = config.customGroups;
            renderSettings();
            addMessage('üì• Configuration imported!', true);
        } catch(err) { alert('‚ùå Invalid config file: ' + err.message); }
    };
    reader.readAsText(file);
    e.target.value = '';
});

document.getElementById('clearSessionsBtn').addEventListener('click', () => {
    if (confirm('Clear ALL session history? This cannot be undone.')) {
        clearAllSessions();
        addMessage('üóëÔ∏è Session history cleared.', true);
    }
});

// ============================================
// INPUT HANDLERS
// ============================================
sendBtn.addEventListener('click', () => {
    const value = messageInput.value.trim();
    if (!value) return;
    if (state.phase === 'setup') {
        addMessage(value, false);
        hideInput();
        setTimeout(() => handleSetupInput(value), 300);
    }
});

messageInput.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBtn.click(); }
});

messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
});

// Close modals on backdrop click
settingsOverlay.addEventListener('click', e => { if (e.target === settingsOverlay) closeSettings(); });
historyOverlay.addEventListener('click', e => { if (e.target === historyOverlay) historyOverlay.classList.remove('show'); });
editModal.addEventListener('click', e => { if (e.target === editModal) closeEditForm(); });

// ============================================
// BACKGROUND / VISIBILITY HANDLING
// Fix for app "closing" when switching away briefly on mobile.
// On mobile browsers, apps are frozen or killed when backgrounded.
// We save draft aggressively on ANY visibility loss.
// ============================================
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'hidden') {
        // App going to background ‚Äî save everything immediately
        saveDraft();
    } else if (document.visibilityState === 'visible') {
        // App came back to foreground
        // If we were mid-session, the page likely reloaded ‚Äî state is already
        // restored via loadConfig() + loadDraft() at init. Nothing extra needed.
    }
});

// pagehide fires more reliably than beforeunload on mobile Safari/Chrome
window.addEventListener('pagehide', () => {
    saveDraft();
});

// pageshow fires when page is restored from bfcache (back-forward cache)
// In this case the JS state is still intact, no reload needed
window.addEventListener('pageshow', (e) => {
    if (e.persisted) {
        // Page was restored from bfcache ‚Äî state still alive, just ensure UI is right
        if (state.phase === 'session') {
            backBtn.classList.add('show');
        }
    }
});

// ============================================
// INIT
// ============================================
loadConfig();
showWelcome();
</script>
</body>
</html>
